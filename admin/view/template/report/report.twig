{# modification tp2
  - suppression de onchange dans le select report.
  - le onchange est réattribué dans le jquery pour tous les options différentes de nos options
 #}

{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="button" data-toggle="tooltip" title="{{ button_filter }}" onclick="$('#filter-report').toggleClass('hidden-sm hidden-xs');" class="btn btn-default hidden-md hidden-lg"><i class="fa fa-filter"></i></button>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-bar-chart"></i> {{ text_type }}</h3>
      </div>
      <div class="panel-body">
        <div class="well">
          <div class="input-group">
          {# suppression de onchange - a remettre pour le ocmod #}
            <select name="report" {#onchange="location = this.value;"#} class="form-control">
              
              {% for report in reports %}
              {% if code == report.code %}
              
              <option value="{{ report.href }}" selected="selected">{{ report.text }}</option>
              
              {% else %}
              
              <option value="{{ report.href }}">{{ report.text }}</option>
              
              {% endif %}
              {% endfor %}
            
            </select>
            <span class="input-group-addon"><i class="fa fa-filter"></i> {{ text_filter }}</span></div>
        </div>
      </div>
    </div>
    {# tp2 ajout de report #}
    <div id="report">{{ report }}</div>
  </div>
</div>
{{ footer }} 

{# TP2 - AJOUT DU RAPPORT #}
{#
  le script :
    - appel les requetes ajax pour nos rapports
    - réaffecte l'événement onchange pour les autres rapports
#}
{% raw %}
<script>
  $(document).ready(function(){
    console.log($('#ajaxAfficherLesVisites').get(0));
    $('.form-control').change(function(){
      let page_a_afficher = $(".form-control option:selected").val();
      if(page_a_afficher.includes("ajaxAfficherLesVisites")){ // verifie si la string 'page_a_afficher' contient 'ajaxAff...'
        afficher_les_visites(page_a_afficher);
      }else if(page_a_afficher == 'voir_olivier'){
        //code olivier
      }else{
        window.open(page_a_afficher,"_self");
      }
    });
  });

  let afficher_les_visites = (requete_ajax) =>{
    $('#report').empty();
      $.ajax({
        url: requete_ajax,
        success:function(donnees)
        {
          var json = JSON.parse(donnees);
          console.log(json);
          for(let ligne of json){
            for(let elt in ligne){
              $('#report').append(ligne[elt]);
            }
            $('#report').append("<br>");
          }
        }
      });
  }
</script>
{% endraw %}
{# fin TP2 - AJOUT DU RAPPORT #}