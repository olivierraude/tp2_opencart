{# modification tp2
  - suppression de onchange dans le select report.
  - le onchange est réattribué dans le jquery pour tous les options différentes de nos options
 #}

{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="button" data-toggle="tooltip" title="{{ button_filter }}" onclick="$('#filter-report').toggleClass('hidden-sm hidden-xs');" class="btn btn-default hidden-md hidden-lg"><i class="fa fa-filter"></i></button>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-bar-chart"></i> {{ text_type }}</h3>
      </div>
      <div class="panel-body">
        <div class="well">
          <div class="input-group">
          {# suppression de onchange - a remettre pour le ocmod #}
            <select name="report" {#onchange="location = this.value;"#} class="form-control">
              
              {% for report in reports %}
              {% if code == report.code %}
              
              <option value="{{ report.href }}" selected="selected">{{ report.text }}</option>
              
              {% else %}
              
              <option value="{{ report.href }}">{{ report.text }}</option>
              
              {% endif %}
              {% endfor %}
            
            </select>
            <span class="input-group-addon"><i class="fa fa-filter"></i> {{ text_filter }}</span></div>
        </div>
      </div>
    </div>
    {# tp2 ajout de report #}
    <div id="report">{{ report }}</div>
  </div>
</div>
{{ footer }} 

{# TP2 - AJOUT DU RAPPORT #}
{#
  le script :
    - appel les requetes ajax pour nos rapports
    - réaffecte l'événement onchange pour les autres rapports
#}
{% raw %}
{# <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">  
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script> #}
<script>
  $(document).ready(function(){
    $('#table_id').DataTable();
    console.log($('#ajaxAfficherLesVisites').get(0));
    $('.form-control').change(function(){
      let page_a_afficher = $(".form-control option:selected").val();
      if(page_a_afficher.includes("ajaxAfficherLesVisites")){ 
        afficher_les_visites(page_a_afficher);
      }else if(page_a_afficher == 'voir_olivier'){
        //code olivier
      }else{
        window.open(page_a_afficher,"_self");
      }
    });
  });

  let afficher_les_visites = (requete_ajax) =>{
    $('#report').empty();
      $.ajax({
        url: requete_ajax,
        success:function(donnees)
        {
          var json = JSON.parse(donnees);
          //console.log(json);
          $('#report').append(`
            <table id="table_id" class="display">
              <thead>
                <tr>
                  <th>date visite</th>
                  <th>titre</th>
                  <th>url page</th>
                  <th>id usager</th>
                  <th>adresse ip</th>
                </tr>
              </thead>
              <tbody>
          `);
          for(let d of json){
            console.log(d);
            $('#report').append(`
                <tr>
                  <td>${ d['date_visite'] }</td>
                  <td>${ d['titre'] }</td>
                  <td>${ d['url_page'] }</td>
                  <td>${ d['id_usager'] }</td>
                  <td>${ d['adresse_ip'] }</td>
                </tr>
            `);
          }
         $('#report').append(`
              </tbody>
            </table>
          `);
        }
      });
  }
</script>
{% endraw %}
{# fin TP2 - AJOUT DU RAPPORT #}